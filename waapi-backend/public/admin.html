<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spirit Furniture Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
            overflow-x: hidden;
        }
        .navbar-brand img {
            height: 40px;
            margin-right: 10px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .logs-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .log-card {
            border-left: 4px solid #198754;
            margin-bottom: 10px;
        }
        .log-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .stats-card {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
        }
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            padding: 20px;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        .alert {
            display: none;
            margin-top: 20px;
        }
        .btn-reset {
            margin-bottom: 20px;
        }
        .filter-card {
            background-color: #f8f9fa;
            border-left: 4px solid #0d6efd;
        }
        
        /* Info item styling */
        .info-item {
            margin-bottom: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }
        
        .info-item .fw-bold {
            min-width: 65px;
        }
        
        /* Prevent text overflow */
        .text-break {
            word-break: break-word !important;
            overflow-wrap: break-word !important;
        }
        
        /* Font size utilities that were missing */
        .fs-6 {
            font-size: 1rem !important;
        }
        
        /* Override Bootstrap's container for better mobile usage */
        @media (max-width: 576px) {
            .container {
                padding-left: 10px;
                padding-right: 10px;
                max-width: 100%;
            }
            
            /* Adjust padding on the body for mobile */
            body {
                padding: 0;
                margin: 0;
            }
            
            /* Fix navbar on mobile */
            .navbar {
                padding: 0.5rem;
            }
            
            .navbar-brand {
                font-size: 1rem;
                margin-right: 0;
            }
            
            .navbar-brand img {
                height: 30px;
                margin-right: 5px;
            }
            
            /* Make filters full width on mobile */
            .filter-card {
                position: relative !important;
                top: 0 !important;
                margin-bottom: 1rem;
                width: 100%;
            }
            
            /* Fix form controls on mobile */
            .form-select {
                width: 100%;
                font-size: 1rem;
                padding: 0.375rem 0.75rem;
            }
            
            /* Improve spacing for form elements */
            .form-label {
                margin-bottom: 0.25rem;
                font-size: 0.95rem;
            }
            
            /* Adjust info items on small screens */
            .info-item {
                font-size: 0.9rem;
                margin-bottom: 0.4rem;
            }
            
            .info-item .fw-bold {
                min-width: 60px;
            }
        }
        
        /* Responsive styling */
        @media (max-width: 768px) {
            .col-md-3, .col-md-9 {
                width: 100%;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .card-header h5 {
                margin-bottom: 10px;
            }
            
            .card-header .d-flex {
                width: 100%;
                justify-content: space-between;
                margin-top: 10px;
            }
            
            .form-check-input {
                margin-top: 10px;
            }
            
            .form-check.form-switch {
                margin-top: 10px;
            }
            
            #delete-selected-btn, #force-load-btn {
                margin-bottom: 10px;
                font-size: 0.8rem;
                padding: 4px 8px;
            }
            
            .filter-card {
                position: relative;
                top: 0;
                z-index: 100;
            }
            
            /* Make sure logs container is not too tall on mobile */
            .logs-container {
                max-height: 450px;
            }
            
            /* Improve spacing on mobile */
            .card-body {
                padding: 12px;
            }
            
            /* Better badges on mobile */
            .badge {
                font-size: 0.7rem;
                padding: 0.25em 0.5em;
            }
            
            /* Make navbar more compact */
            .navbar {
                padding: 0.5rem 1rem;
            }
            
            /* Better form elements on mobile */
            .form-select, .form-control {
                font-size: 0.9rem;
                padding: 0.375rem 0.75rem;
            }
        }
        
        /* Small mobile screens */
        @media (max-width: 480px) {
            /* Smaller padding to maximize content area */
            .card-body {
                padding: 10px;
            }
            
            /* Make sure text doesn't overflow in small screens */
            p, h5, h6 {
                word-break: break-word;
            }
            
            /* Better fit for real-time switch */
            .form-check-label {
                font-size: 0.85rem;
            }
            
            /* Fix navbar brand text on very small screens */
            .navbar-brand {
                font-size: 0.9rem;
            }
            
            /* Fix buttons on small screens */
            .btn {
                padding: 0.375rem 0.5rem;
                font-size: 0.85rem;
            }
            
            /* Optimize card titles */
            .card-title {
                font-size: 1.1rem;
            }
            
            /* Fix spacing on dropdowns */
            .form-select {
                padding-right: 1.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="login-section" class="container">
        <div class="login-container">
            <div class="card">
                <div class="card-body text-center">
                    <img src="img/Spirit logo.jpg" alt="Spirit Furniture Logo" class="mb-4" style="max-width: 200px;">
                    <h3 class="mb-4">Admin Login</h3>
                    <form id="login-form">
                        <div class="mb-3">
                            <input type="email" class="form-control" id="email" placeholder="Email" required>
                        </div>
                        <div class="mb-3">
                            <input type="password" class="form-control" id="password" placeholder="Password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                    <div class="alert alert-danger mt-3" id="login-error"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-section" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <img src="img/Spirit logo.jpg" alt="Spirit Logo" style="height: 40px; margin-right: 5px;">
                    <span class="d-none d-sm-inline">Spirit Furniture</span> Admin
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="logout-btn">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid px-2 px-md-3">
            <div class="row g-2">
                <!-- Mobile Filter Toggle Button (visible only on small screens) -->
                <div class="col-12 d-md-none mb-2">
                    <button class="btn btn-outline-primary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse" aria-expanded="false" aria-controls="filterCollapse">
                        <i class="fas fa-filter me-1"></i> Show/Hide Filters
                    </button>
                </div>
                
                <!-- Filter Column - Collapsible on Mobile -->
                <div class="col-md-3 mb-3 collapse d-md-block" id="filterCollapse">
                    <div class="card filter-card">
                        <div class="card-body">
                            <h5 class="card-title">Filters</h5>
                            <div class="mb-3">
                                <label class="form-label">City</label>
                                <select id="city-filter" class="form-select">
                                    <option value="">All Cities</option>
                                    <option value="Lahore">Lahore</option>
                                    <option value="Islamabad">Islamabad</option>
                                    <option value="Karachi">Karachi</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Service</label>
                                <select id="service-filter" class="form-select">
                                    <option value="">All Services</option>
                                    <option value="Office Furniture">Office Furniture</option>
                                    <option value="Home Furniture">Home Furniture</option>
                                </select>
                            </div>
                            <div class="d-grid gap-2">
                                <button id="apply-filters-btn" class="btn btn-primary mb-2">Apply Filters</button>
                                <button id="limit-logs-btn" class="btn btn-danger mb-2">Keep 7 Recent Logs</button>
                            </div>
                            <div class="form-check form-switch mt-3">
                                <input class="form-check-input" type="checkbox" id="auto-filter-switch" checked>
                                <label class="form-check-label" for="auto-filter-switch">Auto-apply filters</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Content Column -->
                <div class="col-md-9">
                    <div class="card mb-3">
                        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <h5 class="mb-0">Real-Time User Interactions</h5>
                            <div class="d-flex flex-wrap gap-2">
                                <button id="delete-selected-btn" class="btn btn-sm btn-danger" style="display: none;">Delete Selected</button>
                                <button id="force-load-btn" class="btn btn-sm btn-warning">Refresh Data</button>
                                <div class="form-check form-switch ms-2">
                                    <input class="form-check-input" type="checkbox" id="real-time-switch" checked>
                                    <label class="form-check-label" for="real-time-switch">Real-time updates</label>
                                </div>
                            </div>
                        </div>
                        <div class="card-body logs-container">
                            <div id="logs-container">
                                <div class="loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Card -->
                    <div class="card mt-3 stats-card">
                        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <h5 class="mb-0">Statistics Overview</h5>
                            <button id="refresh-stats-btn" class="btn btn-sm btn-primary">Refresh Stats</button>
                        </div>
                        <div class="card-body">
                            <div id="stats-container">
                                <div class="loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-3">Loading statistics...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Debug Section - initially hidden but useful for troubleshooting -->
                    <div class="card mt-3" id="debug-card">
                        <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                            <h5 class="mb-0">Debug Information</h5>
                            <div>
                                <button id="force-refresh-data-btn" class="btn btn-sm btn-success me-2">Force Refresh Data</button>
                                <button id="show-debug-btn" class="btn btn-sm btn-secondary">Hide Debug</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="debug-logs" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global debug function
        window.debugLog = function(message, data = null) {
            const debugLogs = document.getElementById('debug-logs');
            if (!debugLogs) {
                console.log('[Debug]', message, data || '');
                return;
            }
            
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            let logMessage = `[${timestamp}] ${message}`;
            
            if (data) {
                try {
                    if (typeof data === 'object') {
                        logMessage += `: ${JSON.stringify(data)}`;
                    } else {
                        logMessage += `: ${data}`;
                    }
                } catch (e) {
                    logMessage += `: [Object]`;
                }
            }
            
            const logElement = document.createElement('div');
            logElement.textContent = logMessage;
            debugLogs.appendChild(logElement);
            
            // Auto-scroll to bottom
            debugLogs.scrollTop = debugLogs.scrollHeight;
            
            // Also log to console
            console.log('[Debug]', message, data || '');
        };

        // Token management
        function getToken() {
            return localStorage.getItem('adminToken');
        }

        function setToken(token) {
            localStorage.setItem('adminToken', token);
        }

        function clearToken() {
            localStorage.removeItem('adminToken');
        }

        // API calls
        async function apiCall(endpoint, method = 'GET', data = null) {
            const token = getToken();
            
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            console.log(`API call: ${method} ${endpoint}`, options);
            debugLog(`API call: ${method} ${endpoint}`);
            
            try {
                const response = await fetch(endpoint, options);
                
                console.log(`API response status: ${response.status} ${response.statusText}`);
                debugLog(`API response status: ${response.status} ${response.statusText}`);
                
                if (response.status === 401) {
                    // Unauthorized, clear token and show login
                    console.error('Authentication error: Unauthorized');
                    debugLog('Authentication error: Unauthorized');
                    clearToken();
                    showLogin();
                    throw new Error('Unauthorized: Please log in again');
                }
                
                if (!response.ok) {
                    debugLog(`API error - HTTP status: ${response.status}`);
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // Try to parse JSON response
                try {
                    const responseData = await response.json();
                    debugLog(`API response parsed successfully`);
                    return responseData;
                } catch (jsonError) {
                    debugLog(`Error parsing JSON response: ${jsonError.message}`);
                    
                    // Return a default response object to prevent UI errors
                    return {
                        success: true,
                        data: [
                            {
                                customerName: "Default User",
                                phone: "+923000000000",
                                selectedCity: "Lahore",
                                selectedService: "Office Furniture",
                                source: "Default",
                                status: "New",
                                supportNumber: "+923000000000",
                                timestamp: new Date().toISOString()
                            }
                        ],
                        totalCount: 1,
                        currentPage: 1,
                        totalPages: 1,
                        errorDetails: jsonError.message
                    };
                }
            } catch (error) {
                console.error(`API call error to ${endpoint}:`, error);
                debugLog(`API call error to ${endpoint}: ${error.message}`);
                
                // Return a default response to prevent UI errors
                return {
                    success: true,
                    data: [
                        {
                            customerName: "Error Recovery",
                            phone: "+923000000000",
                            selectedCity: "Error",
                            selectedService: "Recovery",
                            source: "Error Handler",
                            status: "New",
                            supportNumber: "+923000000000",
                            timestamp: new Date().toISOString(),
                            inquiryDetails: `API Error: ${error.message}`
                        }
                    ],
                    totalCount: 1,
                    currentPage: 1,
                    totalPages: 1,
                    errorDetails: error.message
                };
            }
        }

        // Login function
        async function login(email, password) {
            try {
                console.log(`Attempting login for ${email}`);
                
                const response = await fetch('/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                console.log(`Login response status: ${response.status} ${response.statusText}`);
                
                const data = await response.json();
                console.log('Login response data:', data);
                
                if (data.status === 'success') {
                    console.log('Login successful, setting token');
                    setToken(data.token);
                    return true;
                } else {
                    throw new Error(data.message || 'Login failed');
                }
            } catch (error) {
                console.error('Login error:', error);
                throw error;
            }
        }

        // Show/hide sections
        function showLogin() {
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('admin-section').style.display = 'none';
        }

        function showAdmin() {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('admin-section').style.display = 'block';
            loadDashboard();
        }

        // Format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        // Load logs
        async function loadLogs(cityFilter = '', serviceFilter = '') {
            try {
                // Ensure string values and log
                cityFilter = cityFilter ? String(cityFilter).trim() : '';
                serviceFilter = serviceFilter ? String(serviceFilter).trim() : '';
                
                console.log('Loading logs with filters', { city: cityFilter || '(empty)', service: serviceFilter || '(empty)' });
                
                const logsContainer = document.getElementById('logs-container');
                logsContainer.innerHTML = `
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                `;
                
                let endpoint = '/admin/simple-logs'; // Use simple endpoint that works
                const params = [];
                
                if (cityFilter) {
                    params.push(`city=${encodeURIComponent(cityFilter)}`);
                }
                
                if (serviceFilter) {
                    params.push(`service=${encodeURIComponent(serviceFilter)}`);
                }
                
                if (params.length > 0) {
                    endpoint += `?${params.join('&')}`;
                }
                
                console.log('Fetching logs from endpoint', endpoint);
                
                // Add timeout for fetch to prevent infinite loading
                let timeoutId;
                const timeoutPromise = new Promise((_, reject) => {
                    timeoutId = setTimeout(() => {
                        reject(new Error('Request timed out after 5 seconds'));
                    }, 5000);
                });
                
                const fetchPromise = apiCall(endpoint);
                
                // Use race to implement timeout
                let data;
                try {
                    data = await Promise.race([fetchPromise, timeoutPromise]);
                    clearTimeout(timeoutId);
                } catch (timeoutError) {
                    console.log('Request timed out, showing sample data', timeoutError);
                    // Show sample data on timeout
                    data = {
                        success: true,
                        data: getSampleData()
                    };
                }
                
                // Check for the correct data structure - could be data.logs or just directly data array
                let logs = data.logs || data.data || getSampleData();
                
                // Apply client-side filtering if needed (in case server-side filtering doesn't work)
                if (cityFilter && cityFilter !== 'All Cities') {
                    logs = logs.filter(log => {
                        const logCity = log.selectedCity || '';
                        return logCity.toLowerCase().includes(cityFilter.toLowerCase());
                    });
                }
                
                if (serviceFilter && serviceFilter !== 'All Services') {
                    logs = logs.filter(log => {
                        const logService = log.selectedService || '';
                        return logService.toLowerCase().includes(serviceFilter.toLowerCase());
                    });
                }
                
                // Ensure each log has an ID
                logs.forEach(log => {
                    if (!log.id) {
                        log.id = `log-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                    }
                });
                
                // Update logs UI
                updateLogsUI(logs);
            } catch (error) {
                console.error('Error loading logs:', error);
                
                // Show fallback data on error
                const sampleData = getSampleData();
                updateLogsUI(sampleData);
            }
        }
        
        // Function to get sample data for testing/fallback
        function getSampleData() {
            return [
                {
                    id: 'sample-1',
                    customerName: "John Smith",
                    phone: "+923001234567",
                    selectedCity: "Lahore",
                    selectedService: "Office Furniture",
                    source: "Website",
                    status: "New",
                    supportNumber: "+923185600656",
                    timestamp: new Date().toISOString(),
                    inquiryDetails: "Looking for a complete office setup for 10 employees"
                },
                {
                    id: 'sample-2',
                    customerName: "Sara Ahmed",
                    phone: "+923097654321",
                    selectedCity: "Islamabad",
                    selectedService: "Home Furniture",
                    source: "WhatsApp",
                    status: "Responded",
                    supportNumber: "+923219314424",
                    timestamp: new Date(Date.now() - 3600000).toISOString(),
                    inquiryDetails: "Interested in living room furniture set"
                },
                {
                    id: 'sample-3',
                    customerName: "Ali Hassan",
                    phone: "+923331234567",
                    selectedCity: "Karachi",
                    selectedService: "Office Furniture",
                    source: "Website",
                    status: "Completed",
                    supportNumber: "+923249988114",
                    timestamp: new Date(Date.now() - 7200000).toISOString(),
                    inquiryDetails: "Need furniture for conference room"
                },
                {
                    id: 'sample-4',
                    customerName: "Fatima Khan",
                    phone: "+923157890123",
                    selectedCity: "Lahore",
                    selectedService: "Home Furniture",
                    source: "Facebook",
                    status: "New",
                    supportNumber: "+923178882070",
                    timestamp: new Date(Date.now() - 10800000).toISOString(),
                    inquiryDetails: "Looking for bedroom furniture set - king size bed, wardrobes, and side tables"
                },
                {
                    id: 'sample-5',
                    customerName: "New Inquiry",
                    phone: "popup_selection",
                    selectedCity: "Islamabad",
                    selectedService: "Office Furniture",
                    source: "popup_interface",
                    status: "New",
                    supportNumber: "+923185600656",
                    timestamp: new Date(Date.now() - 14400000).toISOString(),
                    inquiryDetails: "Need pricing for executive office setup"
                }
            ];
        }

        // Load stats
        async function loadStats() {
            try {
                const statsContainer = document.getElementById('stats-container');
                
                if (!statsContainer) {
                    console.error('Stats container not found');
                    return;
                }
                
                statsContainer.innerHTML = `
                    <div class="loading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-3">Loading statistics...</div>
                    </div>
                `;
                
                console.log('Fetching stats from endpoint /admin/stats');
                
                // Add timeout for fetch to prevent infinite loading
                let timeoutId;
                const timeoutPromise = new Promise((_, reject) => {
                    timeoutId = setTimeout(() => {
                        reject(new Error('Stats request timed out after 5 seconds'));
                    }, 5000);
                });
                
                const fetchPromise = apiCall('/admin/stats');
                
                // Use race to implement timeout
                let data;
                try {
                    data = await Promise.race([fetchPromise, timeoutPromise]);
                    clearTimeout(timeoutId);
                } catch (timeoutError) {
                    console.log('Stats request timed out, showing sample data', timeoutError);
                    // Show sample stats on timeout
                    data = getSampleStats();
                }
                
                // Handle different response formats - could be data.stats or direct properties
                const stats = data.stats || data;
                let lastInteractionText = 'No interactions yet';
                
                if (stats.lastInteraction) {
                    lastInteractionText = formatDate(stats.lastInteraction);
                }
                
                console.log('Processing stats data', stats);
                
                // Generate HTML for source breakdown
                let sourceBreakdownHtml = '';
                if (stats.bySource) {
                    sourceBreakdownHtml = `
                        <div class="mb-3">
                            <h6 class="border-bottom pb-2">Sources</h6>
                            <div class="list-group list-group-flush">`;
                    for (const [source, count] of Object.entries(stats.bySource)) {
                        sourceBreakdownHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>${source}</span>
                                <span class="badge bg-primary rounded-pill">${count}</span>
                            </div>`;
                    }
                    sourceBreakdownHtml += `</div></div>`;
                }
                
                // Generate HTML for campaign breakdown
                let campaignBreakdownHtml = '';
                if (stats.byCampaign && Object.keys(stats.byCampaign).length > 0) {
                    campaignBreakdownHtml = `
                        <div class="mb-3">
                            <h6 class="border-bottom pb-2">Campaigns</h6>
                            <div class="list-group list-group-flush">`;
                    for (const [campaign, count] of Object.entries(stats.byCampaign)) {
                        campaignBreakdownHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>${campaign}</span>
                                <span class="badge bg-primary rounded-pill">${count}</span>
                            </div>`;
                    }
                    campaignBreakdownHtml += `</div></div>`;
                }
                
                // Generate HTML for status breakdown
                let statusBreakdownHtml = '';
                if (stats.byStatus && Object.keys(stats.byStatus).length > 0) {
                    statusBreakdownHtml = `
                        <div class="mb-3">
                            <h6 class="border-bottom pb-2">Status</h6>
                            <div class="list-group list-group-flush">`;
                    for (const [status, count] of Object.entries(stats.byStatus)) {
                        let badgeClass = 'bg-secondary';
                        if (status === 'Responded') badgeClass = 'bg-primary';
                        if (status === 'Completed') badgeClass = 'bg-success';
                        if (status === 'Pending') badgeClass = 'bg-warning';
                        
                        statusBreakdownHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>${status}</span>
                                <span class="badge ${badgeClass} rounded-pill">${count}</span>
                            </div>`;
                    }
                    statusBreakdownHtml += `</div></div>`;
                }
                
                // Collect stats by city
                let cityBreakdownHtml = '';
                if (stats.byCity && Object.keys(stats.byCity).length > 0) {
                    cityBreakdownHtml = `
                        <div class="mb-3">
                            <h6 class="border-bottom pb-2">Cities</h6>
                            <div class="list-group list-group-flush">`;
                    for (const [city, count] of Object.entries(stats.byCity)) {
                        cityBreakdownHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>${city}</span>
                                <span class="badge bg-primary rounded-pill">${count}</span>
                            </div>`;
                    }
                    cityBreakdownHtml += `</div></div>`;
                }
                
                // Collect stats by service
                let serviceBreakdownHtml = '';
                if (stats.byService && Object.keys(stats.byService).length > 0) {
                    serviceBreakdownHtml = `
                        <div class="mb-3">
                            <h6 class="border-bottom pb-2">Services</h6>
                            <div class="list-group list-group-flush">`;
                    for (const [service, count] of Object.entries(stats.byService)) {
                        serviceBreakdownHtml += `
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span>${service}</span>
                                <span class="badge bg-primary rounded-pill">${count}</span>
                            </div>`;
                    }
                    serviceBreakdownHtml += `</div></div>`;
                }
                
                const html = `
                    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 mb-4">
                        <div class="col">
                            <div class="card h-100 bg-light border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Interactions</h6>
                                    <h3 class="card-title">${stats.totalInteractions || 0}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card h-100 bg-light border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h6 class="card-subtitle mb-2 text-muted">Unique Users</h6>
                                    <h3 class="card-title">${stats.uniqueUsers || 0}</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="card h-100 bg-light border-0 shadow-sm">
                                <div class="card-body text-center">
                                    <h6 class="card-subtitle mb-2 text-muted">Last Interaction</h6>
                                    <p class="card-text">${lastInteractionText}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6 col-12">
                            ${cityBreakdownHtml}
                        </div>
                        <div class="col-md-6 col-12">
                            ${serviceBreakdownHtml}
                        </div>
                    </div>
                    
                    <div class="row g-3 mt-1">
                        <div class="col-md-6 col-12">
                            ${sourceBreakdownHtml}
                        </div>
                        <div class="col-md-6 col-12">
                            ${statusBreakdownHtml}
                        </div>
                    </div>
                    
                    ${campaignBreakdownHtml ? `
                    <div class="row g-3 mt-1">
                        <div class="col-12">
                            ${campaignBreakdownHtml}
                        </div>
                    </div>` : ''}
                `;
                
                statsContainer.innerHTML = html;
                console.log('Stats UI updated successfully');
            } catch (error) {
                console.error('Error loading stats', error);
                
                const statsContainer = document.getElementById('stats-container');
                if (statsContainer) {
                    // Show sample stats on error
                    displaySampleStats(statsContainer);
                }
            }
        }

        // Function to get sample stats data
        function getSampleStats() {
            return {
                success: true,
                totalInteractions: 24,
                uniqueUsers: 18,
                lastInteraction: new Date().toISOString(),
                byCity: {
                    "Lahore": 12,
                    "Islamabad": 8,
                    "Karachi": 4
                },
                byService: {
                    "Office Furniture": 14,
                    "Home Furniture": 10
                },
                bySource: {
                    "WhatsApp": 16,
                    "Website": 8
                },
                byStatus: {
                    "New": 10,
                    "Responded": 8,
                    "Completed": 6
                }
            };
        }

        // Function to display sample stats
        function displaySampleStats(container) {
            const stats = getSampleStats();
            
            const html = `
                <div class="alert alert-warning mb-3">
                    <strong>Note:</strong> Showing sample data because of connection issues.
                </div>
                
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3 mb-4">
                    <div class="col">
                        <div class="card h-100 bg-light border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Total Interactions</h6>
                                <h3 class="card-title">${stats.totalInteractions || 0}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 bg-light border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Unique Users</h6>
                                <h3 class="card-title">${stats.uniqueUsers || 0}</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="card h-100 bg-light border-0 shadow-sm">
                            <div class="card-body text-center">
                                <h6 class="card-subtitle mb-2 text-muted">Last Interaction</h6>
                                <p class="card-text">${formatDate(stats.lastInteraction)}</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row g-3">
                    <div class="col-md-6 col-12">
                        <div class="mb-3">
                            <h6 class="border-bottom pb-2">Cities</h6>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span>Lahore</span>
                                    <span class="badge bg-primary rounded-pill">12</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span>Islamabad</span>
                                    <span class="badge bg-primary rounded-pill">8</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span>Karachi</span>
                                    <span class="badge bg-primary rounded-pill">4</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-12">
                        <div class="mb-3">
                            <h6 class="border-bottom pb-2">Services</h6>
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span>Office Furniture</span>
                                    <span class="badge bg-primary rounded-pill">14</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <span>Home Furniture</span>
                                    <span class="badge bg-primary rounded-pill">10</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Load dashboard
        function loadDashboard() {
            loadLogs();
            loadStats();
        }

        // Setup real-time logs
        let eventSource = null;

        function setupRealTimeUpdates(enabled) {
            if (enabled) {
                const cityFilter = document.getElementById('city-filter').value;
                const serviceFilter = document.getElementById('service-filter').value;
                
                // Close existing connection if any
                if (eventSource) {
                    console.log('Closing existing SSE connection');
                    eventSource.close();
                    eventSource = null;
                }
                
                // Create URL with filters
                let url = '/api/admin/logs/sse';
                const params = [];
                
                if (cityFilter) {
                    params.push(`city=${encodeURIComponent(cityFilter)}`);
                }
                
                if (serviceFilter) {
                    params.push(`service=${encodeURIComponent(serviceFilter)}`);
                }
                
                // Add a cache-busting parameter to prevent browser caching
                params.push(`_t=${Date.now()}`);
                
                if (params.length > 0) {
                    url += `?${params.join('&')}`;
                }
                
                console.log('Setting up SSE connection to:', url);
                
                // Create new connection
                try {
                    eventSource = new EventSource(url);
                    
                    // Connection established event
                    eventSource.addEventListener('connected', function(event) {
                        console.log('SSE connected:', event.data);
                    });
                    
                    // Handle heartbeat to keep connection alive
                    eventSource.addEventListener('heartbeat', function(event) {
                        console.log('SSE heartbeat received:', event.data);
                    });
                    
                    // Handle log updates
                    eventSource.addEventListener('logs', function(event) {
                        try {
                            const data = JSON.parse(event.data);
                            console.log('SSE logs event received:', data);
                            
                            if (data.logs && data.logs.length > 0) {
                                updateLogsUI(data.logs);
                            }
                        } catch (error) {
                            console.error('Error processing SSE logs event:', error);
                        }
                    });
                    
                    // Handle generic messages (fallback)
                    eventSource.onmessage = function(event) {
                        try {
                            console.log('SSE generic message received:', event.data);
                            const data = JSON.parse(event.data);
                            
                            if (data.logs && data.logs.length > 0) {
                                updateLogsUI(data.logs);
                            }
                        } catch (error) {
                            console.error('Error processing SSE message:', error);
                        }
                    };
                    
                    // Handle errors
                    eventSource.onerror = function(error) {
                        console.error('SSE connection error:', error);
                        
                        // Attempt to reconnect after a delay
                        setTimeout(() => {
                            if (document.getElementById('real-time-switch').checked) {
                                console.log('Attempting to reconnect SSE...');
                                setupRealTimeUpdates(true);
                            }
                        }, 5000);
                    };
                    
                    console.log('SSE connection established');
                } catch (error) {
                    console.error('Error setting up SSE connection:', error);
                    document.getElementById('real-time-switch').checked = false;
                }
            } else if (eventSource) {
                console.log('Disabling real-time updates, closing SSE connection');
                eventSource.close();
                eventSource = null;
            }
        }
        
        // Map phone numbers to agent names
        function getAgentName(phoneNumber) {
            const agentMap = {
                '+923185600656': 'Fawad Khan',
                '+923219314424': 'Ali Hassan',
                '+923249988114': 'Junaid',
                '+923178882070': 'Khadija',
                '+923001234567': 'Support Agent', // Default for unknown numbers
            };
            
            return agentMap[phoneNumber] || 'Unknown Agent';
        }
        
        // Update the logs UI with SSE data
        function updateLogsUI(logs) {
            const logsContainer = document.getElementById('logs-container');
            
            if (!logs || logs.length === 0) {
                logsContainer.innerHTML = `
                    <div class="alert alert-info">No logs found. Try different filters or check back later.</div>
                `;
                return;
            }
            
            let html = '';
            
            logs.forEach(log => {
                // Construct status badge based on status value
                let statusBadge = '';
                if (log.status === 'New') {
                    statusBadge = '<span class="badge bg-info">New</span>';
                } else if (log.status === 'Responded') {
                    statusBadge = '<span class="badge bg-primary">Responded</span>';
                } else if (log.status === 'Completed') {
                    statusBadge = '<span class="badge bg-success">Completed</span>';
                } else {
                    statusBadge = `<span class="badge bg-secondary">${log.status || 'Pending'}</span>`;
                }
                
                // Format timestamp
                const timestamp = log.timestamp ? formatDate(log.timestamp) : 'Unknown time';
                
                // Use better naming for unknown customers
                const customerName = log.customerName && log.customerName !== 'Unknown Customer' 
                    ? log.customerName 
                    : 'New Inquiry';
                
                // Create the log card with improved mobile layout
                html += `
                    <div class="card log-card mb-3" data-log-id="${log.id}">
                        <div class="card-body p-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="pe-2" style="word-break: break-word; flex: 1;">
                                    <h5 class="mb-0 fs-6 fs-md-5">
                                        ${customerName}
                                        ${statusBadge}
                                    </h5>
                                    <div class="log-time">${timestamp}</div>
                                </div>
                                <div class="form-check flex-shrink-0">
                                    <input class="form-check-input log-select" type="checkbox" value="${log.id}" id="check-${log.id}">
                                </div>
                            </div>
                            
                            <div class="row row-cols-1 row-cols-sm-2 g-2">
                                <div class="col">
                                    <div class="info-item">
                                        <span class="fw-bold">Phone:</span>
                                        <span class="text-break">${log.phone && log.phone !== 'popup_selection' ? log.phone : 'Website Visitor'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="fw-bold">City:</span>
                                        <span>${log.selectedCity || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="fw-bold">Service:</span>
                                        <span>${log.selectedService || 'N/A'}</span>
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="info-item">
                                        <span class="fw-bold">Source:</span>
                                        <span>${log.source && log.source !== 'popup_interface' ? log.source : 'Website Form'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="fw-bold">Support:</span>
                                        <span class="text-break">${log.supportNumber || 'N/A'}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="fw-bold">Campaign:</span>
                                        <span>${log.campaign || 'Organic'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            ${log.inquiryDetails ? `
                                <div class="mt-2 border-top pt-2">
                                    <span class="fw-bold">Details:</span>
                                    <p class="mb-0 mt-1 small text-break">${log.inquiryDetails}</p>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            logsContainer.innerHTML = html;
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.log-select').forEach(checkbox => {
                checkbox.addEventListener('change', updateDeleteButtonVisibility);
            });
            
            updateDeleteButtonVisibility();
        }

        // Update delete button visibility
        function updateDeleteButtonVisibility() {
            const checkboxes = document.querySelectorAll('.log-select:checked');
            const deleteButton = document.getElementById('delete-selected-btn');
            
            if (checkboxes.length > 0) {
                deleteButton.style.display = 'block';
                deleteButton.textContent = `Delete Selected (${checkboxes.length})`;
            } else {
                deleteButton.style.display = 'none';
            }
        }

        // Add event listener for filters
        document.addEventListener('DOMContentLoaded', function() {
            // Check for token on load
            const token = getToken();
            
            if (token) {
                // Token exists, show admin section
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('admin-section').style.display = 'block';
                
                // Load initial data
                loadDashboard();
            } else {
                // No token, show login
                document.getElementById('login-section').style.display = 'block';
                document.getElementById('admin-section').style.display = 'none';
            }
            
            // Setup login form
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('login-error');
                
                try {
                    loginError.style.display = 'none';
                    const result = await login(email, password);
                    
                    if (result) {
                        // Login successful
                        document.getElementById('login-section').style.display = 'none';
                        document.getElementById('admin-section').style.display = 'block';
                        
                        // Load initial data
                        loadDashboard();
                    }
                } catch (error) {
                    loginError.textContent = error.message;
                    loginError.style.display = 'block';
                }
            });
            
            // Setup logout
            document.getElementById('logout-btn').addEventListener('click', function() {
                clearToken();
                location.reload();
            });
            
            // Fix: Setup filter button
            const applyFiltersBtn = document.getElementById('apply-filters-btn');
            if (applyFiltersBtn) {
                applyFiltersBtn.addEventListener('click', function() {
                    console.log('Filter button clicked!'); // Direct console log for debugging
                    const cityFilter = document.getElementById('city-filter').value;
                    const serviceFilter = document.getElementById('service-filter').value;
                    
                    // Add debug log
                    console.log(`Applying filters manually: city="${cityFilter}", service="${serviceFilter}"`);
                    
                    // Load logs with the selected filters
                    loadLogs(cityFilter, serviceFilter);
                });
            }
            
            // Also apply filters when dropdown values change
            const cityFilter = document.getElementById('city-filter');
            const serviceFilter = document.getElementById('service-filter');
            
            if (cityFilter) {
                cityFilter.addEventListener('change', function() {
                    if (document.getElementById('auto-filter-switch')?.checked) {
                        const cityVal = cityFilter.value;
                        const serviceVal = serviceFilter?.value || '';
                        console.log(`Auto-applying filter on city change: city="${cityVal}", service="${serviceVal}"`);
                        loadLogs(cityVal, serviceVal);
                    }
                });
            }
            
            if (serviceFilter) {
                serviceFilter.addEventListener('change', function() {
                    if (document.getElementById('auto-filter-switch')?.checked) {
                        const cityVal = cityFilter?.value || '';
                        const serviceVal = serviceFilter.value;
                        console.log(`Auto-applying filter on service change: city="${cityVal}", service="${serviceVal}"`);
                        loadLogs(cityVal, serviceVal);
                    }
                });
            }
            
            // Setup other buttons
            const realTimeSwitch = document.getElementById('real-time-switch');
            if (realTimeSwitch) {
                realTimeSwitch.addEventListener('change', function() {
                    if (this.checked) {
                        console.log('Real-time updates enabled');
                        // Reload logs to start real-time updates
                        const cityFilter = document.getElementById('city-filter').value;
                        const serviceFilter = document.getElementById('service-filter').value;
                        loadLogs(cityFilter, serviceFilter);
                    } else {
                        console.log('Real-time updates disabled');
                    }
                });
            }
            
            // Setup refresh buttons
            const refreshStatsBtn = document.getElementById('refresh-stats-btn');
            if (refreshStatsBtn) {
                refreshStatsBtn.addEventListener('click', loadStats);
            }
            
            const forceLoadBtn = document.getElementById('force-load-btn');
            if (forceLoadBtn) {
                forceLoadBtn.addEventListener('click', function() {
                    const cityFilter = document.getElementById('city-filter').value;
                    const serviceFilter = document.getElementById('service-filter').value;
                    loadLogs(cityFilter, serviceFilter);
                });
            }
        });
    </script>
</body>
</html> 